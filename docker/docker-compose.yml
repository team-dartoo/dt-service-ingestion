# ============================================================
# Ingestion Service - Docker Compose
# ============================================================
# 독립 실행 가능한 공시 수집 서비스
#
# 사용법:
#   cd ingestion-service/docker
#   docker-compose up -d --build    # 서비스 시작
#   docker-compose logs -f          # 로그 확인
#   docker-compose down             # 서비스 중지
#
# 또는 (서비스 루트에서):
#   docker-compose -f docker/docker-compose.yml up -d --build
#
# 사전 요구사항:
#   1. docker network create dartoo-network
#   2. Disclosure Service가 먼저 실행되어 있어야 함
#
# Mock 모드 (DART API Key 없이 테스트):
#   MOCK_MODE=true 환경변수 설정 (.env 파일)
# ============================================================

version: '3.8'

services:
  # ============================================================
  # RabbitMQ Message Broker
  # ============================================================
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: ingestion-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin123}
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - dartoo-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ============================================================
  # MinIO Object Storage
  # ============================================================
  minio:
    image: minio/minio:latest
    container_name: ingestion-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin123}
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    networks:
      - dartoo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ============================================================
  # MinIO Bucket 초기화
  # ============================================================
  minio-init:
    image: minio/mc
    container_name: ingestion-minio-init
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin123}
      MINIO_BUCKET: ${MINIO_BUCKET:-dart-disclosures}
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - dartoo-network
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb myminio/$${MINIO_BUCKET} --ignore-existing;
      mc anonymous set public myminio/$${MINIO_BUCKET};
      echo 'MinIO bucket [$${MINIO_BUCKET}] initialized';
      exit 0;
      "

  # ============================================================
  # Producer Service (DART API 폴링)
  # ============================================================
  producer:
    build:
      context: ..
      dockerfile: docker/Dockerfile.producer
    container_name: ingestion-producer
    env_file:
      - ../.env
    environment:
      # MinIO (컨테이너명 사용)
      MINIO_ENDPOINT: ingestion-minio:9000
      # Celery/RabbitMQ (컨테이너명 사용)
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@ingestion-rabbitmq:5672/
    ports:
      - "${HEALTH_PORT:-8001}:8001"
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    networks:
      - dartoo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health/live"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================================
  # Consumer Service (Celery Worker)
  # ============================================================
  consumer:
    build:
      context: ..
      dockerfile: docker/Dockerfile.consumer
    container_name: ingestion-consumer
    env_file:
      - ../.env
    environment:
      # Celery/RabbitMQ (컨테이너명 사용)
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@ingestion-rabbitmq:5672/
      # Disclosure Service (dartoo-network를 통해 접근)
      DISCLOSURE_SERVICE_URL: http://disclosure-api:8000
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - dartoo-network
    restart: unless-stopped

# ============================================================
# Networks - 외부 네트워크 사용 (Disclosure Service와 공유)
# ============================================================
networks:
  dartoo-network:
    external: true
    name: dartoo-network

# ============================================================
# Volumes
# ============================================================
volumes:
  rabbitmq_data:
  minio_data:
